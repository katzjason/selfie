services:
    web:
        build:
            context: .
            args:
                NEXT_PUBLIC_VERSION: ${VERSION:-dev}
                NEXT_PUBLIC_API_BASE_URL: https://${LAN_IP}
        ports:
        - "3000:3000"
        environment:
        - IMAGE_DIR=/data/images
        - NODE_ENV=production
        - DATABASE_URL=postgresql://app:${DB_PASSWORD}@db:5432/selfie
        - MRN_KEY_PATH=/run/secrets/mrn_hmac_key
        - NEXT_PUBLIC_API_BASE_URL=https://${LAN_IP}
        volumes:
        - selfie_images:/data/images
        - /opt/selfie/secrets/mrn_hmac_key:/run/secrets/mrn_hmac_key:ro
        depends_on:
        - db
        # secrets:
        #     - source: mrn_hmac_key
        #       target: /run/secrets/mrn_hmac_key
        #       uid: "1001"
        #       gid: "1001"
        #       mode: 0440
    caddy:
        image: caddy:2
        ports:
        - "0.0.0.0:443:443"
        - "0.0.0.0:8080:80"
        volumes:
        - ./Caddyfile:/etc/caddy/Caddyfile:ro
        - ./certs:/certs:ro
        - caddy_data:/data
        - caddy_config:/config
        environment:
        - LAN_IP=${LAN_IP}
        depends_on:
        - web

    db:
        image: postgres:16-alpine
        environment:
        - POSTGRES_DB=selfie
        - POSTGRES_USER=app
        - POSTGRES_PASSWORD=${DB_PASSWORD}
        volumes:
        - postgres_data:/var/lib/postgresql/data
        - ./db/init/init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
        ports:
        - "5433:5432"

# secrets:
#     mrn_hmac_key:
#         file: /opt/selfie/secrets/mrn_hmac_key

volumes:
  selfie_images:
  postgres_data:
  caddy_data:
  caddy_config: